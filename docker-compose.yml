services:
  grafana:
    container_name: grafana-monitoring-platform
    build:
      context: ops/grafana
      dockerfile: Dockerfile
    ports:
      - 3000:3000
    environment:
      - GF_PATHS_CONFIG=/etc/grafana/custom.ini
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.traefik-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.sslheaders.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.grafana-monitoring-platform.entrypoints=http"
      - "traefik.http.routers.grafana-monitoring-platform.rule=Host(`monitoring-platform.test`)"
      - "traefik.http.routers.grafana-monitoring-platform.middlewares=traefik-https-redirect"
      - "traefik.http.routers.grafana-monitoring-platform-secure.entrypoints=https"
      - "traefik.http.routers.grafana-monitoring-platform-secure.rule=Host(`monitoring-platform.test`)"
      - "traefik.http.routers.grafana-monitoring-platform-secure.tls=true"
      - "traefik.http.routers.grafana-monitoring-platform-secure.tls.domains[0].main=monitoring-platform.test"
      - "traefik.http.routers.grafana-monitoring-platform-secure.tls.domains[0].sans=*.monitoring-platform.test"
      - "traefik.http.routers.grafana-monitoring-platform-secure.service=grafana-monitoring-platform"
      - "traefik.http.services.grafana-monitoring-platform.loadbalancer.server.scheme=https"
      - "traefik.http.services.grafana-monitoring-platform.loadbalancer.server.port=3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./ops/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./ops/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - ./ops/grafana/custom.ini:/etc/grafana/custom.ini
      - ./var/logs/grafana:/var/log/grafana

  monitoring-platform-mkcert:
    container_name: monitoring-platform-mkcert
    image: webgrip/traefik-local-development-mkcert:latest
    pull_policy: always
    volumes:
      - ~/.config/mkcert:/root/.local/share/mkcert:ro
      - certificate-data:/certificate-data:rw
    entrypoint: [ "/app/entrypoint.sh", "monitoring-platform.test" ]

  monitoring-platform-loki:
    container_name: monitoring-platform-loki
    image: grafana/loki:2.9.8
    ports:
      - "3100:3100"
    volumes:
      - ./ops/loki:/etc/loki
      - ./ops/loki/local-config.yaml:/etc/loki/local-config.yaml
      - ./var/loki/wal:/wal
      - ./var/loki/chunks:/chunks
      - ./var/loki/index:/index
    environment:
      - LOKI_STORAGE_PATH=/wal
      - LOKI_CHUNKS_PATH=/chunks
      - LOKI_INDEX_PATH=/index

  monitoring-platform-tempo:
    container_name: monitoring-platform-tempo
    depends_on:
      monitoring-platform-otel-collector:
        condition: service_started
    image: webgrip/monitoring-platform-tempo:latest
    build:
      context: ./ops/tempo
      dockerfile: Dockerfile
    command: [ "-config.file=/etc/tempo.yaml" ]
    volumes:
      - ./ops/tempo/tempo.yaml:/etc/tempo.yaml
    ports:
      - "14268:14268" # jaeger ingest
      - "3200:3200" # tempo
      - "4317:4317" # otlp grpc
      - "4318:4318" # otlp http
      - "9411:9411" # zipkin

  monitoring-platform-k6-tracing:
    container_name: monitoring-platform-k6-tracing
    image: ghcr.io/grafana/xk6-client-tracing:v0.0.5
    environment:
      - "ENDPOINT=monitoring-platform-otel-collector:4317"
    restart: always
    depends_on:
      - monitoring-platform-otel-collector

  monitoring-platform-otel-collector:
    container_name: monitoring-platform-otel-collector
    image: webgrip/monitoring-platform-otel-collector:latest
    build:
      context: ./ops/otel-collector
      dockerfile: Dockerfile
    command: ["--config", "/etc/otelcol-contrib/config.yaml"]
    volumes:
      - ./ops/otel-collector/config.yml:/etc/otelcol-contrib/config.yaml
#    ports:
#      - "1888:1888"   # pprof extension
#      - "8888:8888"   # Prometheus metrics exposed by the collector
#      - "8889:8889"   # Prometheus exporter metrics
#      - "13133:13133" # health_check extension
#      - "4317:4317"   # OTLP gRPC receiver
#      - "4318:4318"   # OTLP HTTP receiver

  monitoring-platform-mariadb:
    container_name: monitoring-platform-mariadb
    build:
      context: ./ops/mariadb
      dockerfile: Dockerfile
    ports:
      - 3307:3306
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: monitor
      MYSQL_USER: monitor
      MYSQL_PASSWORD: monitor


volumes:
  grafana-data:
  certificate-data:
    external: true

networks:
  default:
    external: true
    name: webgrip
